# https://docs.percona.com/percona-xtradb-cluster/8.0/load-balance-proxysql.html#manual-configuration
---
- name: Configure ProxySQL
  hosts: ProxySQL
  gather_facts: yes
  become: yes

  vars:
    required_packages:
      - percona-xtradb-cluster-client
      - proxysql2
      - python3-mysqldb

  vars_files:
    - ../../../vault.yml

  tasks:
#    - name: Download the repository package
#      ansible.builtin.get_url:
#        url: "https://repo.percona.com/apt/percona-release_latest.generic_all.deb"
#        dest: "/tmp/percona-release_latest.generic_all.deb"
#
#    - name: Install the package with dpkg
#      ansible.builtin.apt:
#        deb: "/tmp/percona-release_latest.generic_all.deb"
#
#    - name: Update apt repository cache
#      ansible.builtin.apt:
#        update_cache: yes
#
#    - name: Enable the release repository for Percona XtraDB Cluster
#      ansible.builtin.shell: percona-release setup pxc80
#
#    - name: Install Required Packages
#      package:
#        name: "{{ required_packages }}"
#        state: present

    - name: Retrieve MySQL Root user password from HashiCorp Vault
      # NOTE: This password is created manually and stored in vault at path below. 36 characters generated by random.org
      set_fact:
        percona_creds: "{{ lookup('hashi_vault', 'secret=kv/data/percona_cluster/pxc-cluster token={{ hashicorp_vault_token }} url={{ hashicorp.vault.address }}') }}"
      no_log: true

    - name: Verify Percona Cluster is up
      mysql_query:
        login_host: "{{ groups['PerconaCluster'][0] }}" # This should be the bootstrap node
        login_user: root
        login_password: "{{ percona_creds.root_password }}"
        query: "SHOW STATUS LIKE 'wsrep_cluster_size';"
      register: cluster_status

    - debug:
        msg: "{{ cluster_status.msg.query_result[0].Value }}"